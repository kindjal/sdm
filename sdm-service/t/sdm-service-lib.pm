
package SDM::Test::Lib;

use strict;
use warnings;

BEGIN {
    # testing means use sqlite db, we do want to commit.
    $ENV{SDM_DEPLOYMENT} ||= "testing";
    $ENV{UR_DBI_NO_COMMIT} = 0;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 0;
};

use Test::More;
use FindBin;
use Cwd qw/abs_path/;
use File::Basename qw/dirname/;
use IPC::Cmd qw/can_run/;
use Data::Dumper;

use_ok( 'SDM', "ok: loaded SDM");
use_ok( 'SDM::DataSource::Service', "ok: loaded SDM::DataSource::Service");

my $ds = SDM::DataSource::Service->get();
my $driver = $ds->driver;
my $top = dirname dirname abs_path(__FILE__);
my $base = "$top/lib/SDM";
my $perl = "$^X -I $top/lib -I $top/../sdm/lib";
my $sdm = can_run("sdm");
unless ($sdm) {
    if (-e "./sdm-service/sdm/bin/sdm") {
        $sdm = "./sdm-service/sdm/bin/sdm";
    } elsif (-e "./sdm/bin/sdm") {
        $sdm = "./sdm/bin/sdm";
    } elsif (-e "../sdm/bin/sdm") {
        $sdm = "../sdm/bin/sdm";
    } else {
        die "Can't find 'sdm' executable";
    }
}
ok( defined $sdm, "ok: sdm found in PATH");

sub new {
    my $class = shift;
    my $self = {
        'perl' => $perl,
        'sdm' => $sdm,
    };
    bless $self,$class;
    return $self;
}

sub runcmd {
    my $self = shift;
    my $command = shift;
    $ENV{SDM_NO_REQUIRE_USER_VERIFY} ||= 1;
    print("$command\n");
    system("$command");
    if ($? == -1) {
         print "failed to execute: $!\n";
    } elsif ($? & 127) {
         printf "child died with signal %d, %s coredump\n",
             ($? & 127),  ($? & 128) ? 'with' : 'without';
    } else {
         printf "child exited with value %d\n", $? >> 8;
    }
    ok( $? >> 8 == 0, "ok: $command") or die;
}

sub testinit {
    my $self = shift;
    if ($driver eq "SQLite") {
        print "flush sqlite3 DB\n";
        unlink "$base/DataSource/Service.sqlite3";
        unlink "$base/DataSource/Service.sqlite3-dump";
        unlink "$base/DataSource/Service.sqlite3n";
        unlink "$base/DataSource/Service.sqlite3n-dump";
        print "make new sqlite3 DB\n";
        $self->runcmd("/usr/bin/sqlite3 $base/DataSource/Service.sqlite3n < $base/DataSource/Service.sqlite3n.schema");
        $self->runcmd("/usr/bin/sqlite3 $base/DataSource/Service.sqlite3n .dump > $base/DataSource/Service.sqlite3n-dump");
    }

    if ($driver eq "Pg") {
        print "flush and remake psql DB\n";
        $self->runcmd("/usr/bin/psql -w -d system -U system < $base/DataSource/Service.psql.schema >/dev/null");
    }

    if ($driver eq "Oracle") {
        print "Use Oracle DB\n";
        open FILE, "<$base/DataSource/Service.oracle.schema";
        my $sql = do { local $/; <FILE> };
        close(FILE);
        my $login = $ds->login;
        my $auth = $ds->auth;
        open ORA, "| sqlplus -s $login/$auth\@gcdev" or die "Can't pipe to sqlplus: $!";
        print ORA $sql;
        print ORA "exit";
        close(ORA);
    }

    print "flush and remake Meta\n";
    unlink "$base/DataSource/Meta.sqlite3";
    unlink "$base/DataSource/Meta.sqlite3n";
    unlink "$base/DataSource/Meta.sqlite3-dump";
    unlink "$base/DataSource/Meta.sqlite3n-dump";
    return 0;
}

sub testdata {
    my $self = shift;
    return 0;
}

1;

