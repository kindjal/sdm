<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"> 
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    <title>Disk Usage Information</title>
    <style type="text/css" title="currentStyle">
          @import "/res/css/diskusage_page.css";
          @import "/res/css/diskusage_table.css";
    </style>
    <link rel="shortcut icon" href="favicon.ico" />
    <script type="text/javascript" language="javascript" charset="utf-8" src="/res/js/jquery.js"></script>
    <script type="text/javascript" language="javascript" charset="utf-8" src="/res/js/pkg/DataTables/media/js/jquery.dataTables.js"></script>
    <script type="text/javascript" language="javascript" charset="utf-8" src="/res/js/pkg/TableTools/media/ZeroClipboard/ZeroClipboard.js"></script>
    <script type="text/javascript" language="javascript" charset="utf-8" src="/res/js/pkg/TableTools/media/js/TableTools.js"></script>
    <style type="text/css">
      @import "/res/js/pkg/TableTools/media/css/TableTools.css";
    </style>
    <script type="text/javascript" charset="utf-8">
      $(document).ready(function() {
        TableToolsInit.sSwfPath = "/res/js/pkg/TableTools/media/swf/ZeroClipboard.swf";

        /* Top of page total summary */
        /* Note here we artificially mimic what datatables does below.
           If we want client side formatting, query ?_=1.
           If we want server side formatting, have no query */
        $.getJSON('/site/system/disk/filer/summary.html.cgi?_=1', function(result) {
          $("div#total").html(
            '<h2><a href="rrd.html?total">Cumulative Disk Usage</a></h2>'
            + '<h3>Disk usage added over all reporting NFS servers</h3>'
            + 'Total KB: ' + commify(result.total_kb) + " " + sizeSuffix( result.total_kb ) + '<br/>'
            + 'Used KB: ' + commify(result.used_kb) + " " + sizeSuffix( result.used_kb ) + '<br/>'
            + 'Percentage Consumed: ' + result.capacity.toFixed(0) + ' %<br/>'
            + 'Last Check: ' + result.last_modified + '<br/>'
          );
          $("div#total").addClass('emphasis');
        });
        /* end top */

        /* filer table */
        $('#hosts').dataTable( {
          "bProcessing": false,
          "bServerSide": false,
          "iDisplayLength": 10,
          "sPaginationType": "full_numbers",
          "bAutoWidth": false,
          "sAjaxSource": "/site/system/disk/filer/status.html.cgi",
          "aoColumns": [
            null,
            /* snmp_ok */ { "bVisible":    true },
            null,
            null,
            { "sClass" : "center" },
            { "sClass" : "center" },
          ],
          "aaSorting": [ [1,'asc'] ],
          "fnRowCallback": function( nRow, aaData, iDisplayIndex ) {
                var $col = 1;
                var $cell = $(nRow).children('td').eq(0);
                if (aaData[1] == -1) {
                  $cell.addClass('warning');
                }
                if (aaData[1] == 0) {
                  $cell.addClass('notice');
                }
              return nRow;
          },
        } );
        /* end filer table */

        /* summary by disk group table */
        $('#group').dataTable( {
          "sDom": 'T<"clear">lfrtip',
          "bProcessing": false,
          "bServerSide": false,
          "iDisplayLength": 25,
          "sPaginationType": "full_numbers",
          "sAjaxSource": "/site/system/disk/volume/summary.html.cgi",
          "aaSorting": [ [1,'desc'] ],
          "aoColumns": [
            /* disk group column */
            null,
            /* total_kb column */
            { "sType": "numeric",
              "bUseRendered": false,
              "fnRender": function ( oObj ) {
                return oObj.oSettings.fnFormatNumber( oObj.aData[1] ) + " " + sizeSuffix( oObj.aData[1] );
               },
            },
            /* used_kb column */
            { "sType": "numeric",
              "bUseRendered": false,
              "fnRender": function ( oObj ) {
                return oObj.oSettings.fnFormatNumber( oObj.aData[2] ) + " " + sizeSuffix( oObj.aData[2] );
              },
            },
            /* capacity column */
            { "sType": "numeric",
              "bUseRendered": false,
              "fnRender": function ( oObj ) {
                return oObj.aData[3].toFixed(0) + " %";
              },
            }
          ],
          "fnRowCallback": function( nRow, aaData, iDisplayIndex )
          {
            /* append a css class based on cell content */
            /* capacity > 95 */
            var $col = 3;
            var $cell = $(nRow).children('td').eq($col);
            if ( aaData[$col] > 95 )
            {
              $cell.addClass('warning');
            }
            /* group is 'unknown' */
            var $col = 0;
            var $cell = $(nRow).children('td').eq($col);
            if ( aaData[$col] == 'unknown' )
            {
              $cell.addClass('warning');
            }

            return nRow;
          }
        } );
        /* end summary by disk group*/

        /* volume table */
        $('#volume').dataTable( {
          "sDom": 'T<"clear">lfrtip',
          "bProcessing": false,
          "bFilter": true,
          "iDisplayLength": 25,
          "sPaginationType": "full_numbers",
          "sAjaxSource": "/site/system/disk/volume/status.html.cgi",
          /* Sort by Total KB column by default */
          "aaSorting": [ [1,'desc'] ],
          "aoColumns": [
            null,
            /* total_kb column */
            { "sType": "numeric",
              "bUseRendered": false,
              "fnRender": function ( oObj ) {
                return oObj.oSettings.fnFormatNumber( oObj.aData[1] ) + " " + sizeSuffix( oObj.aData[1] );
              },
            },
            /* used_kb column */
            { "sType": "numeric",
              "bUseRendered": false,
              "fnRender": function ( oObj ) {
                return oObj.oSettings.fnFormatNumber( oObj.aData[2] ) + " " + sizeSuffix( oObj.aData[2] );
              },
            },
            /* capacity column */
            { "sType": "numeric",
              "bUseRendered": false,
              "fnRender": function ( oObj ) {
                return oObj.aData[3].toFixed(0) + " %";
              },
            },
            null,
            null,
            null,
          ],
          "fnRowCallback": function( nRow, aaData, iDisplayIndex )
          {
              /* append a css class based on cell content */
              /* capacity > 95 is column 3*/
              var $col = 3;
              var $cell = $(nRow).children('td').eq($col);
              if ( aaData[$col] > 95 )
              {
                $cell.addClass('warning');
              }
              /* group is 'unknown' is column 4 */
              var $col = 4;
              var $cell = $(nRow).children('td').eq($col);
              if ( aaData[$col] == 'unknown' )
              {
                $cell.addClass('warning');
              }
              return nRow;
          },
        } );
        /* end volume summary table */

        /* take a big number of KB and make it pretty: 1,000 => (1 MB) */
        function sizeSuffix ( n ) {
          var size = String(n).length
          var units
          var divisor
          switch(true) {
            case size < 4:
                units = 'KB'
                divisor = 1
                break
            case (size >= 4 && size < 7):
                units = 'MB'
                divisor = 1000
                break
            case (size >= 7 && size < 10):
                units = 'GB'
                divisor = 1000000
                break
            case (size >= 10 && size < 13):
                units = 'TB'
                divisor = 1000000000
                break
            case (size >= 13 && size < 16):
                units = 'PB'
                divisor = 1000000000000
                break
            case (size >= 16 && size < 19):
                units = 'EB'
                divisor = 1000000000000000
                break
          }
          var shortVal = n / divisor
          return "(" + String( shortVal.toFixed(0) ) + " " + units + ")"
        };

        /* Add commas to a number */
        function commify(n) {
          nStr = String(n)
          x = nStr.split('.')
          x1 = x[0]
          x2 = x.length > 1 ? '.' + x[1] : ''
          var rgx = /(\d+)(\d{3})/;
          while (rgx.test(x1)) {
            x1 = x1.replace(rgx, '$1' + ',' + '$2');
          }
          return x1 + x2;
        };


      } ); /* end document ready function */
    </script>
  </head>
  <body id="dt_example">
    <div id="container">
      <h1>Disk Usage Report</h1>

      <p>This table shows disk consumption information as reported by SNMP from NFS servers.</p>

      <div id="narrow">
      <div id="total">
      </div>
      </div>

      <h1>Hosts Providing Storage Volumes</h1>

      <div class="emphasis" id="narrow">
      Hosts that reported SNMP errors are red.<br/>
      Hosts that reported no Volume data are orange.<br/>
      </div>

      <div id="hosts_table">
      <table cellpadding="0" cellspacing="0" border="0" class="display" id="hosts">
      <thead>
      <tr>
      <th>Filer</th>
      <th width="1%">SNMP Status</th>
      <th>Hosts</th>
      <th>Arrays</th>
      <th>Added</th>
      <th>Last Successful Check</th>
      </tr>
      </thead>
      <tbody>
      <tr>
      <td colspan="6" class="dataTables_empty">Loading data from server</td>
      </tr>
      </tbody>
      <tfoot>
      <tr>
      <th>Filer</th>
      <th width="1%">SNMP Status</th>
      <th>Hosts</th>
      <th>Arrays</th>
      <th>Added</th>
      <th>Last Successful Check</th>
      </tr>
      </tfoot>
      </table>
      </div>

      <div class="clear"></div>

      <h1>Disk Usage by Disk Group</h1>

      <div class="emphasis" id="narrow">
      Groups over 95% capacity are red, as is the 'unknown' group.<br/>
      </div>

      <div id="group_table">
      <table cellpadding="0" cellspacing="0" border="0" class="display" id="group">
      <thead>
      <tr>
      <th>Disk Group Name</th>
      <th>Total KB</th>
      <th>Used KB</th>
      <th width="1%">Capacity</th>
      </tr>
      </thead>
      <tbody>
      <tr>
      <td colspan="4" class="dataTables_empty">Loading data from server</td>
      </tr>
      </tbody>
      <tfoot>
      <tr>
      <th>Disk Group Name</th>
      <th>Total KB</th>
      <th>Used KB</th>
      <th width="1%">Capacity</th>
      </tr>
      </tfoot>
      </table>
      </div>

      <div class="clear"></div>

      <h1>Disk Usage By Volume</h1>

      <div class="emphasis" id="narrow">
      Volumes over 95% capacity are colored red, as is the 'unkown' group.
      </div>

      <div id="volume_table">
      <table cellpadding="0" cellspacing="0" border="0" class="display" id="volume">
        <thead>
        <tr>
        <th>Mount Path</th>
        <th width="15%">Total KB</th>
        <th width="15%">Used KB</th>
        <th width="2%" align=center>Capacity</th>
        <th>Disk Group</th>
        <th>Filer</th>
        <th>Last Checked</th>
        </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="7" class="dataTables_empty">Loading data from server</td>
          </tr>
        </tbody>
        <tfoot>
        <tr>
        <th>Mount Path</th>
        <th width="15%">Total KB</th>
        <th width="15%">Used KB</th>
        <th width="2%" align=center>Capacity</th>
        <th>Disk Group</th>
        <th>Filer</th>
        <th>Last Checked</th>
        </tr>
        </tfoot>
      </table>
      </div> <!-- end of volume div -->

      <h1>Frequently Asked Questions</h1>

      <div class="emphasis">
      <p>Q: What's the cumulative disk consumption?<br/>
      A: See the <a href=#total>Totals section</a>.</p>
      <p>Q: How much space is a specific group consuming?<br/>
      A: See the <a href=#group>Disk Usage By Disk Group</a> table below.</p>
      <p>Q: How much space has not yet been assigned to a group?<br/>
      A: See the <a href=#volume>Disk Volumes</a> table, sort by group name and find <b>unknown</b>.</p>
      <p>Q: How much space has not yet been made available?<br/>
      A: That answer is not available from this page. We would have to query storage arrays directly, rather than the filesystems, and this isn't currently possible.</p>
      <p>Q: How does a volume show up in these stats?<br/>
      A: A host running nfsd and snmpd must be present in the configuration file used by the "diskusage" cron job on this host, and the Volumes that it serves must begin with a prefix path coded into disk_usage.pl (currently "/home" and "/vol").</p>
      </div>

    </div> <!-- end of container -->
  </body>
</html>

